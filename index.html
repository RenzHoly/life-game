<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="./test.css">
  <script src="https://unpkg.com/gpu.js@2.0.0-rc.23/dist/gpu-browser.min.js"></script>
  <script type="module">

    const SIZE = 5
    const WIDTH = Math.ceil(window.innerWidth / SIZE)
    const HEIGHT = Math.ceil(window.innerHeight / SIZE)

    const array = []
    for (let i = 0; i < WIDTH * HEIGHT; i++) {
      array.push(1)
    }

    const gpu = new GPU()
    const multiplyMatrix = gpu.createKernel(function (a) {
      const around = (a[this.thread.y - 1][this.thread.x - 1])
        + (a[this.thread.y - 1][this.thread.x])
        + (a[this.thread.y - 1][this.thread.x + 1])
        + (a[this.thread.y][this.thread.x - 1])
        + (a[this.thread.y][this.thread.x + 1])
        + (a[this.thread.y + 1][this.thread.x - 1])
        + (a[this.thread.y + 1][this.thread.x])
        + (a[this.thread.y + 1][this.thread.x + 1])
      if (a[this.thread.y][this.thread.x] === 1) {
        if (around === 2 || around === 3) {
          return 1
        }
        return 0
      }
      if (around === 3) {
        return 1
      }
      return 0
    }).setOutput([WIDTH, HEIGHT])

    function drawPoint(x, y, value) {
      if (!value) {
        return
      }
      const div = document.createElement('div')
      div.id = `${x}-${y}`
      div.className = 'cell'
      div.style.left = `${x * SIZE}px`
      div.style.top = `${y * SIZE}px`
      document.body.appendChild(div)
    }

    function aaa(cc) {
      document.body.innerHTML = ''
      for (let x = 0; x < WIDTH; x++) {
        for (let y = 0; y < HEIGHT; y++) {
          drawPoint(x, y, cc[y][x])
        }
      }
      setTimeout(() => {
        aaa(multiplyMatrix(cc))
      }, 50)
    }

    aaa(GPU.input(new Float32Array(array), [WIDTH, HEIGHT]).value)
  </script>
</head>

<body>

</body>

</html>
