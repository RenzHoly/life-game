<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Life game with variation</title>
  <link rel="stylesheet" href="./style.css">
  <script src="https://unpkg.com/gpu.js@2.0.0-rc.23/dist/gpu-browser.min.js"></script>
  <script type="module">

    const SIZE = 8
    const DENSITY = 0.12
    const RADIATION = 400
    const FPS = 16
    const WIDTH = Math.ceil(window.innerWidth / SIZE)
    const HEIGHT = Math.ceil(window.innerHeight / SIZE)

    // init
    const array = []
    for (let i = 0; i < WIDTH * HEIGHT; i++) {
      array.push(Math.random() < DENSITY ? 1 : 0)
    }

    const gpu = new GPU()

    const prepare = gpu.createKernel(function (a) {
      return a[this.thread.y][this.thread.x]
    }).setOutput([WIDTH, HEIGHT])

    const reproduction = gpu.createKernel(function (a) {
      // variation
      if (Math.random() < this.constants.RADIATION / this.constants.WIDTH / this.constants.HEIGHT) {
        return Math.round(Math.random() * 2)
      }

      const x = this.thread.x
      const y = this.thread.y

      function checkBoundary(y, x) {
        if (x >= 0 && x < this.constants.WIDTH && y >= 0 && y < this.constants.HEIGHT) {
          return 1
        }
        return 0
      }

      let around = 0
      if (checkBoundary(y - 1, x - 1) === 1) {
        around += a[y - 1][x - 1]
      }
      if (checkBoundary(y - 1, x) === 1) {
        around += a[y - 1][x]
      }
      if (checkBoundary(y - 1, x + 1) === 1) {
        around += a[y - 1][x + 1]
      }
      if (checkBoundary(y, x - 1) === 1) {
        around += a[y][x - 1]
      }
      if (checkBoundary(y, x + 1) === 1) {
        around += a[y][x + 1]
      }
      if (checkBoundary(y + 1, x - 1) === 1) {
        around += a[y + 1][x - 1]
      }
      if (checkBoundary(y + 1, x) === 1) {
        around += a[y + 1][x]
      }
      if (checkBoundary(y + 1, x + 1) === 1) {
        around += a[y + 1][x + 1]
      }

      if (a[y][x] === 1) {
        if (around === 2 || around === 3) {
          return 1
        }
        return 0
      }
      if (around === 3) {
        return 1
      }
      return 0
    }).setOutput([WIDTH, HEIGHT]).setConstants({ WIDTH, HEIGHT, RADIATION })

    const diff = gpu.createKernel(function (a, b) {
      const x = this.thread.x
      const y = this.thread.y

      if (a[y][x] === b[y][x]) {
        return 0
      }
      if (b[y][x] === 1) {
        return 1
      }
      return -1
    }).setOutput([WIDTH, HEIGHT])

    function drawPoint(x, y, d) {
      if (d === 1) {
        const div = document.createElement('div')
        div.id = `${x}-${y}`
        div.className = 'cell'
        div.style.left = `${x * SIZE}px`
        div.style.top = `${y * SIZE}px`
        document.body.appendChild(div)
        return
      }
      if (d === -1) {
        const existed = document.getElementById(`${x}-${y}`)
        if (existed) {
          document.body.removeChild(existed)
        }
        return
      }
    }

    function nextGeneration(c) {
      const cc = reproduction(c)
      const d = diff(c, cc)
      for (let x = 0; x < WIDTH; x++) {
        for (let y = 0; y < HEIGHT; y++) {
          drawPoint(x, y, d[y][x])
        }
      }
      setTimeout(() => {
        nextGeneration(cc)
      }, 1000 / FPS)
    }

    nextGeneration(prepare(GPU.input(array, [WIDTH, HEIGHT])))
  </script>
</head>

<body>

</body>

</html>
